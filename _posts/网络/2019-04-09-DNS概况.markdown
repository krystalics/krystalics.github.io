参考文章两篇 1.[关于DNS你应该了解的相关概念和原理](<https://juejin.im/post/5c88b8f7518825068d1d1d7e>) 2.[谈谈流量劫持与防治](https://zhuanlan.zhihu.com/p/40682772) 

---

DNS全名是Domain Name System 域名系统 ，DNS是学习配置一个站点或者服务时比较难的一部分。先来一些基本概念

一个域名是我们用来**关联**换一个互联网资源的一个人性化的名字。举个例子，google.com 就是一个域名，而不是google，我们知道一个域名时对应一个IP地址。

##### 顶级域名：

顶级域名又称TLD Top-Level Domain ，它保存DNS根域的名字空间中。顶级域名时域名的最后一个部分，如 google.com 中 顶级域是 .com 。为什么要区分域名的层次呢？这个部分由ICANN (互联网名称与数字地址分配机构)进行管理分配的，

##### 子域名：

DNS是由层级的，TLD底下可以有很多域名，比如"com"这个顶级域名下面会有google.com 和 "ubuntu.com" 等域名。我们把其中的ubuntu称为SLD(Second level domain)二级域名 ，也就是每个域名可以控制位于它底下的所有子域名。比如为学校的计算机学院分配一个"www.cs.school.edu" 其中cs 部分就是一个子域名。

##### Name Server 名字服务器

名字服务器是一台设计用来转换域名到IP地址的计算机。这些服务器在DNS域名系统中做很多事情。因为这么多数量的域名转换工作都让一台服务器来干太多了，因此每台服务器把请求重定向到其他名字服务器或当它们响应时委派响应给它们的子域名。

##### Zone File 区域文件

一个区域文件时一个简单的文本，只包含了域名名字和IP地址之间的映射，而区域文件存放在域名服务器上，通常定义了指定域名下可以访问的资源或者能够获得信息的地方。

##### Record 记录

在区域文件上还有record记录，一条记录就是一条资源到名字的单一映射。

##### 

##### DNS的工作原理：

Root Server 根服务器

正如我们上面说的，DNS的核心是一套层级系统。在这套系统的顶层就是我们所称的根服务器。这些服务器被各个组织所控制，并有ICANN授权。

全球目前有13台根服务器，然而每分钟的请求太多，所以事实上有很多这些服务器的镜像，这些镜像服务器的IP竟然和单根服务器共享同样的IP地址。当请求要发送到一台根服务器，这个请求会被路由到最近的镜像根服务器。

镜像服务器处理请求，那么根服务器都做些什么呢？-》 **根服务器处理关于顶级域名信息的请求，** 因此如果一个请求在低层级的域名服务器上无法解决，就会查询根服务器。**事实上它们会把请求指向处理指定顶级域名的名字服务器来处理** 

所以当我们发送给根服务器的请求是这样的：“www.wikipedia.org” 根服务器如果在它的record记录中没有找到结果，它会检查它的区域文件查看是否匹配 www.wikipedia.org 当然它不会找不到。

一般都会找到一条关于TLD “rog”的记录，然后把org地址的名字服务器地址返回

请求者会根据根服务器提供的新地址发送新请求，这就是顶级域名对这条请求的响应。



```
domain.com.  IN SOA ns1.domain.com. admin.domain.com. (
                                            12083   ; serial number
                                            3h      ; refresh interval
                                            30m     ; retry interval
                                            3w      ; expiry period
                                            1h      ; negative TTL
)
```

domain. com 是区域的根。这里指定这个zone文件是给domain.com这个域名的。

IN SOA：“IN”这个部分的意思是internet ，SOA是指示符，用来表示这是 个SOA记录

ns1.domain.com ： 这里定义了这个域名的主名字服务器。名字服务器可以是主服务器或者从服务器。如果动态DNS被配置，那这里就需要一台主名字服务器

admin.domain.com ： 这里是zone区域的管理员的email地址，email地址中的@被替代为一个点 ，如果邮箱地址中有点那么这里需要用一个反斜杠来替代。比如 you.name@domain.com 这里需要写出 you\name.domain.com 

12803: 这个是zone文件的序列号。每次编辑一个zone文件，必须要增加一次这个文件的数字让它正确传播。从服务器会检查主服务器的zone文件的序列号是否比他们系统里现有的序列号大。如果是就会请求一个新的zone文件

3h: 这个是zone文件刷新间隔周期 

30m:重试zone文件的时间间隔，如果从机在刷新时间无法连接主机就会等待一段时间并重新尝试轮询主机

3w:过期时间，如果从服务器在这段时间内无法连接主服务器，它就不能作为这个区域的权威来发挥响应

1h：这个时间段是名字服务器缓存一个名字错误的时间量，如果他不能在文件中找到请求的名字



而记录的常规格式是这样的

```
host IN A     IPv4_address
host IN AAAA  IPv6_address

ns1 In A 111.222.111.222
```



##### CNAME记录

定义了一个给定的服务（一个通过A记录或者AAAA记录定义的）名字的别名。

比如我们已经定义了一条A记录叫server1的host 然后用www来定义一个host的别名

```
server1 IN A 111.111.111.111
www IN CNAME server1
```

使用别名会有性能上的损失，只有一种情况下推荐使用：为当前区域以外的资源提供别名

还有很多其他的零碎点就不讲了。



##### 了解完DNS的内部之后来点宏观分析

DNS是使用一种UDP协议进行域名查询的协议，其最主要的目标就是将域名转换为IP地址。以查询www.meituan.com 对应的IP地址为例，操作系统首先会在本地尝试解析，因为我们可能在hosts文件中配置了映射，同时如果有解析缓存的话也会去查询。如果在浏览器中查询也会有查询缓存这一步。

在查询没有结果时，设备最终会开始向域名服务器发起查询请求。公共域名服务器一般是用户的ISP提供的，这种公共域名服务器通常会缓存查询结果，因此如果缓存命中，查询就可以到此结束。而缓存的是有时效性的，被称为TTL。对于超过时效的查询结果，域名服务器有义务重新发起查询请求。

未命中缓存的查询，公共域名服务器会向顶级域名服务器进行查询。以我们的例子来说，因为公共域名服务器不知道`meituan.com`的解析权归谁，因此它会向顶级域名服务器——`com`域名服务器——发起请求，寻找`meituan.com`对应的域名服务器。顶级域名服务器一般是由域名经营机构来维护的，有些甚至归属国家机关管理，例如国别域名。理论上来说，在顶级域名服务器之上还有一个根域名服务器，不过在平时很难意识到它的存在。